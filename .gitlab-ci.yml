include:
  - /ci/templates/gitlab-ci-lint.yml
  - /ci/templates/gitlab-ci-test.yml
  - /ci/templates/gitlab-ci-rules.yml
  - /ci/templates/gitlab-ci-build.yml

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - services/**/.npm/

default:
  before_script:
    - npm ci --ignore-scripts
    - npm ci --prefix $PROJECT_PATH --cache $PROJECT_PATH/.npm --prefer-offline

stages:
  - generate
  - analyze
  - test
  - build
  - deploy

#----------------------------------------------------------------------
#
# Jobs
#
#----------------------------------------------------------------------

#-----------------------------------
# Prisma Client
#-----------------------------------

lint:prisma:
  extends:
    - .lint
    - .run_on_prisma_change
  script:
    - npm run prisma:generate --prefix $PROJECT_PATH
    - npm run lint --prefix $PROJECT_PATH
  variables:
    PROJECT_PATH: packages/prisma

test:prisma:
  extends:
    - .test
    - .run_on_prisma_change
  services:
    - postgres
  script:
    - npm run prisma:generate --prefix $PROJECT_PATH
    - npm run test --prefix $PROJECT_PATH
  variables:
    POSTGRES_DB: a11y-challenges
    POSTGRES_USER: a11y-challenges
    POSTGRES_PASSWORD: secret
    DB_URL: postgresql://a11y-challenges:secret@postgres:5432/a11y-challenges
    PROJECT_PATH: packages/prisma

build:prisma:
  tags:
    - docker
  stage: generate
  image: node:14-alpine
  variables:
    PROJECT_PATH: packages/prisma
  script:
    - npm run prisma:generate --prefix $PROJECT_PATH
    - npm run build --prefix $PROJECT_PATH
  artifacts:
    paths:
      - $PROJECT_PATH/dist
      - $PROJECT_PATH/client
  only:
    - develop
    - master
    - merge_request

#-----------------------------------
# Submission Checker
#-----------------------------------

lint:submission-checker:
  extends:
    - .lint
    - .run_on_submission-checker_change
  variables:
    PROJECT_PATH: services/submission-checker

test:submission-checker:
  extends:
    - .test
    - .run_on_submission-checker_change
  variables:
    PROJECT_PATH: services/submission-checker

#-----------------------------------
# API
#-----------------------------------

generate-graphql-schema:api:
  tags:
    - docker
  stage: generate
  image: node:14-alpine
  variables:
    PROJECT_PATH: services/api
  script: npm run generate-schema --prefix $PROJECT_PATH
  artifacts:
    paths:
      - $PROJECT_PATH/schema.gql
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

lint:api:
  extends:
    - .lint
    - .run_on_api_change
  variables:
    PROJECT_PATH: services/api

test:api:
  extends:
    - .test
    - .run_on_api_change
  variables:
    PROJECT_PATH: services/api

production-dependencies:api:
  tags:
    - docker
  stage: build
  # install dependencies using node 12 since lambdas run in a node 12 environment
  image: node:12-alpine
  variables:
    PROJECT_PATH: services/api
  before_script:
    - '' # disable default npm install
  script:
    - npm ci --production --prefix $PROJECT_PATH --cache $PROJECT_PATH/.npm --prefer-offline
    - find $PROJECT_PATH/* -mtime +10950 -exec touch {} \; # search for files with corrupt timestamps and update them
  artifacts:
    paths:
      - $PROJECT_PATH/node_modules
    expire_in: 1 day
  only:
    - master
    - develop

build:api:
  extends:
    - .build
  variables:
    PROJECT_PATH: services/api
  only:
    - master
    - develop
  artifacts:
    paths:
      - $PROJECT_PATH/dist
    expire_in: 1 day

#-----------------------------------
# Site
#-----------------------------------

lint:site:
  extends:
    - .lint
    - .run_on_site_change
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site

test:site:
  extends:
    - .test
    - .run_on_site_change
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site

build:site:
  extends:
    - .build
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site
  artifacts:
    paths:
      - $PROJECT_PATH/.next
    expire_in: 1 day
  only:
    - master
    - develop

production-dependencies:site:
  tags:
    - docker
  stage: build
  image:
    name: public.ecr.aws/lambda/nodejs:12
    entrypoint: [""]
  variables:
    PROJECT_PATH: services/site
  before_script:
    - '' # disable default npm install
  cache: {} # disable cache because lambda/nodejs uses centOS
  script:
    - npm ci --production --prefix $PROJECT_PATH
    - find $PROJECT_PATH/* -mtime +10950 -exec touch {} \; # search for files with corrupt timestamps and update them
  artifacts:
    paths:
      - $PROJECT_PATH/node_modules
    expire_in: 1 day
  only:
    - master
    - develop

#-----------------------------------
# Import Challenges
#-----------------------------------

lint:import-challenges:
  extends:
    - .lint
    - .run_on_import_challenges_change
  needs:
    - build:prisma
  variables:
    PROJECT_PATH: services/import-challenges
  before_script:
    - npm ci --ignore-scripts
    - npm ci --prefix $PROJECT_PATH --cache $PROJECT_PATH/.npm --prefer-offline
    - npm run prisma:generate --prefix services/import-challenges

test:import-challenges:
  extends:
    - .test
    - .run_on_import_challenges_change
  needs:
   - build:prisma
  variables:
    POSTGRES_DB: a11y-challenges
    POSTGRES_USER: a11y-challenges
    POSTGRES_PASSWORD: secret
    DB_URL: postgresql://a11y-challenges:secret@postgres:5432/a11y-challenges
    PROJECT_PATH: services/import-challenges
  services:
    - postgres
  before_script:
    - npm ci --ignore-scripts
    - npm ci --prefix $PROJECT_PATH --cache $PROJECT_PATH/.npm --prefer-offline
    - npm run prisma:generate --prefix services/import-challenges


#-----------------------------------
# Database Migrations
#-----------------------------------

lint:database-migration:
  extends:
    - .lint
    - .run_on_database_migration_change
  variables:
    PROJECT_PATH: services/database-migration

production-dependencies:database-migration:
  tags:
    - docker
  stage: build
  image:
    name: public.ecr.aws/lambda/nodejs:12
    entrypoint: [""]
  variables:
    PROJECT_PATH: services/database-migration
  before_script:
    - '' # disable default npm install
  cache: {} # disable cache because lambda/nodejs uses centOS
  script:
    - npm ci --production --prefix $PROJECT_PATH
    - find $PROJECT_PATH/* -mtime +10950 -exec touch {} \; # search for files with corrupt timestamps and update them
  artifacts:
    paths:
      - $PROJECT_PATH/node_modules
    expire_in: 1 day
  only:
    - master
    - develop

#-----------------------------------
# Terraform
#-----------------------------------

terraform:cloud:validate:
  extends:
    - .run_on_terraform_change
  tags:
    - docker
  stage: analyze
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  before_script:
    - terraform -chdir=terraform/cloud init
  script:
    - terraform -chdir=terraform/cloud validate

terraform:local:validate:
  extends:
    - .run_on_terraform_change
  tags:
    - docker
  stage: analyze
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  before_script:
    - terraform -chdir=terraform/local init
  script:
    - terraform -chdir=terraform/local validate

#-----------------------------------
# Deployment
#-----------------------------------

deploy:
  tags:
    - docker
  stage: deploy
  needs:
    - build:api
    - production-dependencies:api
    - production-dependencies:database-migration
    - build:site
    - production-dependencies:site
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  cache: {} # disable cache
  before_script:
    - apk update
    - apk add zip
    - terraform -chdir=terraform/cloud init
    - terraform -chdir=terraform/cloud workspace select $CI_COMMIT_REF_SLUG
  script:
    - terraform -chdir=terraform/cloud apply -var="current_version=$CI_COMMIT_REF_NAME" -var="postgres_cluster_root_user=root" -var="postgres_cluster_root_password=$TF_PROD_POSTGRES_CLUSTER_ROOT_PASSWORD" -auto-approve
  only:
    - master
    - develop