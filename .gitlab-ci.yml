include:
  - /ci/templates/gitlab-ci-npm-dependencies.yml
  - /ci/templates/gitlab-ci-lint.yml
  - /ci/templates/gitlab-ci-test.yml

stages:
  - prepare
  - generate
  - analyze
  - test

#----------------------------------------------------------------------
#
# Rules
#
#----------------------------------------------------------------------

.api_rules: &api_rules
  - if: ($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_PIPELINE_SOURCE == "merge_request_event")
      changes:
        - services/api/**/*


.site_rules: &site_rules
  - if: ($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_PIPELINE_SOURCE == "merge_request_event")
    changes:
      - services/site/**/*

.submission-checker_rules: &submission-checker_rules
  - if: ($CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_PIPELINE_SOURCE == "merge_request_event")
    changes:
      - services/submission-checker/**/*

#----------------------------------------------------------------------
#
# Jobs
#
#----------------------------------------------------------------------

#-----------------------------------
# Submission Checker
#-----------------------------------

install-dependencies:submission-checker:
  extends: .npm-dependencies
  variables:
    PROJECT_PATH: services/submission-checker
  rules:
    - *submission-checker_rules

lint:submission-checker:
  extends: .lint
  needs:
    - install-dependencies:submission-checker
  variables:
    PROJECT_PATH: services/submission-checker
  rules:
    - *submission-checker_rules

test:submission-checker:
  extends: .test
  needs:
    - install-dependencies:submission-checker
  variables:
    PROJECT_PATH: services/submission-checker
  rules:
    - *submission-checker_rules

#-----------------------------------
# API
#-----------------------------------

install-dependencies:api:
  extends: .npm-dependencies
  variables:
    PROJECT_PATH: services/api
  rules:
    - *api_rules
    - *site_rules


generate-graphql-schema:api:
  tags:
    - docker
  stage: generate
  needs:
    - install-dependencies:api
  image: node:14-alpine
  variables:
    PROJECT_PATH: services/api
  script: npm run generate-schema --prefix $PROJECT_PATH
  artifacts:
    paths:
      - $PROJECT_PATH/schema.gql
  rules:
    - *api_rules
    - *site_rules

lint:api:
  extends: .lint
  needs:
    - install-dependencies:api
  variables:
    PROJECT_PATH: services/api
  rules:
    - *api_rules

test:api:
  extends: .test
  needs:
    - install-dependencies:api
  variables:
    PROJECT_PATH: services/api
  rules:
    - *api_rules

#-----------------------------------
# Site
#-----------------------------------

install-dependencies:site:
  extends: .npm-dependencies
  variables:
    PROJECT_PATH: services/site
  rules:
    - *site_rules

lint:site:
  extends: .lint
  needs:
    - install-dependencies:site
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site
  rules:
    - *site_rules

test:site:
  extends: .test
  needs:
    - install-dependencies:site
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site
  rules:
    - *site_rules
