include:
  - /ci/templates/gitlab-ci-lint.yml
  - /ci/templates/gitlab-ci-test.yml
  - /ci/templates/gitlab-ci-rules.yml
  - /ci/templates/gitlab-ci-build.yml

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - services/**/.npm/

default:
  before_script:
    - npm ci --prefix $PROJECT_PATH --cache $PROJECT_PATH/.npm --prefer-offline

stages:
  - generate
  - analyze
  - test
  - build
  - deploy

#----------------------------------------------------------------------
#
# Jobs
#
#----------------------------------------------------------------------

#-----------------------------------
# Submission Checker
#-----------------------------------

lint:submission-checker:
  extends:
    - .lint
    - .run_on_submission-checker_change
  variables:
    PROJECT_PATH: services/submission-checker

test:submission-checker:
  extends:
    - .test
    - .run_on_submission-checker_change
  variables:
    PROJECT_PATH: services/submission-checker

#-----------------------------------
# API
#-----------------------------------

generate-graphql-schema:api:
  extends:
    - .run_on_site_or_api_change
  tags:
    - docker
  stage: generate
  image: node:14-alpine
  variables:
    PROJECT_PATH: services/api
  script: npm run generate-schema --prefix $PROJECT_PATH
  artifacts:
    paths:
      - $PROJECT_PATH/schema.gql
    expire_in: 1 day

lint:api:
  extends:
    - .lint
    - .run_on_api_change
  variables:
    PROJECT_PATH: services/api

test:api:
  extends:
    - .test
    - .run_on_api_change
  variables:
    PROJECT_PATH: services/api

build:api:
  extends:
    - .build
  variables:
    PROJECT_PATH: services/api
  only:
    - master
    - develop
    - merge_requests

#-----------------------------------
# Site
#-----------------------------------

lint:site:
  extends:
    - .lint
    - .run_on_site_change
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site

test:site:
  extends:
    - .test
    - .run_on_site_change
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site

deploy:
  tags:
    - docker
  stage: deploy
  needs:
    - build:api
  image: pahud/aws-sam-cli
  before_script:
   - '' # overwrites default before_script
  script:
    - sam deploy
  only:
    - master
    - develop
    - merge_requests