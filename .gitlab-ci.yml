include:
  - /ci/templates/gitlab-ci-lint.yml
  - /ci/templates/gitlab-ci-test.yml
  - /ci/templates/gitlab-ci-rules.yml
  - /ci/templates/gitlab-ci-build.yml
  - /ci/templates/gitlab-ci-production-dependencies.yml
  - /ci/templates/gitlab-ci-deploy.yml

cache:
  key: ${CI_COMMIT_REF_SLUG}-alpine
  paths:
    - .npm-alpine

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: 1
  DOCKER_CLI_EXPERIMENTAL: enabled

default:
  before_script:
    - npm ci --ignore-scripts --cache .npm-alpine
    - npm ci --prefix $PROJECT_PATH --cache .npm-alpine --prefer-offline

stages:
  - build-packages
  - generate
  - analyze
  - test
  - build
  - deploy
  - post-deployment

#----------------------------------------------------------------------
#
# Jobs
#
#----------------------------------------------------------------------

#-----------------------------------
# Prisma Client
#-----------------------------------

lint:prisma:
  extends:
    - .lint
    - .run_on_prisma_change
  script:
    - npm run prisma:generate --prefix $PROJECT_PATH
    - npm run lint --prefix $PROJECT_PATH
  variables:
    PROJECT_PATH: packages/prisma

test:prisma:
  extends:
    - .test
  services:
    - postgres
  script:
    - npm run prisma:generate --prefix $PROJECT_PATH
    - npm run test:coverage --prefix $PROJECT_PATH
  variables:
    POSTGRES_DB: a11y-challenges
    POSTGRES_USER: a11y-challenges
    POSTGRES_PASSWORD: secret
    DB_URL: postgresql://a11y-challenges:secret@postgres:5432/a11y-challenges
    PROJECT_PATH: packages/prisma
  only:
    - master
    - develop
    - merge_request

build:prisma:
  tags:
    - docker
  stage: build-packages
  image: docker:20
  variables:
    PROJECT_PATH: packages/prisma
    IMAGE_NAME: a11y-challenges/a11y-challenges/prisma-package
    IMAGE: $CI_REGISTRY/$IMAGE_NAME:review-$CI_MERGE_REQUEST_IID
  cache: {}
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $IMAGE || (docker pull $CI_REGISTRY/$IMAGE_NAME && docker tag $CI_REGISTRY/$IMAGE_NAME $IMAGE || echo "")
    - docker build . -f $PROJECT_PATH/Dockerfile -t $IMAGE --cache-from $IMAGE
    - docker push $IMAGE
    # extract artifacts for compatability with the existing pipeline
    - CONTAINER_ID=$(docker create $IMAGE "")
    - docker cp $CONTAINER_ID:dist - > $PROJECT_PATH/dist.tar
    - docker cp $CONTAINER_ID:client - > $PROJECT_PATH/client.tar
    - cd $PROJECT_PATH
    - tar -xvf dist.tar
    - tar -xvf client.tar
  artifacts:
    expire_in: 1 day
    paths:
      - $PROJECT_PATH/dist
      - $PROJECT_PATH/client
  only:
    - develop
    - master
    - merge_request

production-dependencies:prisma:
  extends:
    - .production-dependencies
  variables:
    PROJECT_PATH: packages/prisma
  only:
    - develop
    - master
    - merge_request


#-----------------------------------
# NestJS AWS Messaging
#-----------------------------------

lint:nestjs-aws-messaging:
  extends:
    - .lint
    - .run_on_nestjs_aws_messaging_change
  variables:
    PROJECT_PATH: packages/nestjs-aws-messaging

test:nestjs-aws-messaging:
  extends:
    - .test
  variables:
    PROJECT_PATH: packages/nestjs-aws-messaging
  only:
    - master
    - develop
    - merge_request

build:nestjs-aws-messaging:
  tags:
    - docker
  stage: build-packages
  image: node:14-alpine
  variables:
    PROJECT_PATH: packages/nestjs-aws-messaging
  script:
    - npm run build --prefix $PROJECT_PATH
  artifacts:
    expire_in: 1 day
    paths:
      - $PROJECT_PATH/dist
  only:
    - develop
    - master
    - merge_request

#-----------------------------------
# Submission Checker
#-----------------------------------

lint:submission-checker:
  extends:
    - .lint
    - .run_on_submission-checker_change
  variables:
    PROJECT_PATH: services/submission-checker

test:submission-checker:
  extends:
    - .test
  variables:
    PROJECT_PATH: services/submission-checker
  only:
    - master
    - develop
    - merge_request

production-dependencies:submission-checker:
  extends:
    - .production-dependencies
  variables:
    PROJECT_PATH: services/submission-checker
  only:
    - master
    - develop
    - merge_request

build:submission-checker:
  extends:
    - .build
  variables:
    PROJECT_PATH: services/submission-checker
  artifacts:
    paths:
      - $PROJECT_PATH/dist
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

#-----------------------------------
# Submission Renderer
#-----------------------------------

lint:submission-renderer:
  extends:
    - .lint
    - .run_on_submission_renderer_change
  variables:
    PROJECT_PATH: services/submission-renderer

test:submission-renderer:
  extends:
    - .test
  variables:
    PROJECT_PATH: services/submission-renderer
  only:
    - master
    - develop
    - merge_request

production-dependencies:submission-renderer:
  extends:
    - .production-dependencies
  variables:
    PROJECT_PATH: services/submission-renderer
  only:
    - master
    - develop
    - merge_request

build:submission-renderer:
  extends:
    - .build
  variables:
    PROJECT_PATH: services/submission-renderer
  artifacts:
    paths:
      - $PROJECT_PATH/dist
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

#-----------------------------------
# API
#-----------------------------------

generate-graphql-schema:api:
  tags:
    - docker
  stage: generate
  image: node:14-alpine
  variables:
    PROJECT_PATH: services/api
  script: npm run generate-schema --prefix $PROJECT_PATH
  artifacts:
    paths:
      - $PROJECT_PATH/schema.gql
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

lint:api:
  extends:
    - .lint
    - .run_on_api_change
  variables:
    PROJECT_PATH: services/api

test:api:
  extends:
    - .test
  needs:
   - build:prisma
  services:
    - postgres
  variables:
    POSTGRES_DB: a11y-challenges
    POSTGRES_USER: a11y-challenges
    POSTGRES_PASSWORD: secret
    DB_URL: postgresql://a11y-challenges:secret@postgres:5432/a11y-challenges
    PROJECT_PATH: services/api
  before_script:
    - npm ci --ignore-scripts --cache .npm-alpine
    - npm ci --prefix packages/prisma --cache .npm-alpine --prefer-offline
    - npm ci --prefix $PROJECT_PATH --cache .npm-alpine --prefer-offline
  only:
    - master
    - develop
    - merge_request

build:api:
  tags:
    - docker
  stage: build
  image: docker:20
  variables:
    PROJECT_PATH: services/api
    IMAGE_NAME: a11y-challenges/a11y-challenges/api
    IMAGE: $CI_REGISTRY/$IMAGE_NAME:review-$CI_MERGE_REQUEST_IID
  cache: {}
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $IMAGE || (docker pull $CI_REGISTRY/$IMAGE_NAME && docker tag $CI_REGISTRY/$IMAGE_NAME $IMAGE || echo "")
    - docker build . -f $PROJECT_PATH/Dockerfile -t $IMAGE --cache-from $IMAGE --build-arg PRISMA_PACKAGE_IMAGE=$CI_REGISTRY/a11y-challenges/a11y-challenges/prisma-package --build-arg VERSION=review-$CI_MERGE_REQUEST_IID
    - docker push $IMAGE
  only:
    - master
    - develop
    - merge_request

#-----------------------------------
# Site
#-----------------------------------

lint:site:
  extends:
    - .lint
    - .run_on_site_change
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site

test:site:
  extends:
    - .test
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site
  only:
    - master
    - develop
    - merge_request

build:site:
  extends:
    - .build
  needs:
    - generate-graphql-schema:api
  variables:
    PROJECT_PATH: services/site
  artifacts:
    paths:
      - $PROJECT_PATH/.next
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

production-dependencies:site:
  extends:
    - .production-dependencies
  variables:
    PROJECT_PATH: services/site
  only:
    - master
    - develop
    - merge_request

#-----------------------------------
# Import Challenges
#-----------------------------------

lint:import-challenges:
  extends:
    - .lint
    - .run_on_import_challenges_change
  needs:
    - build:prisma
  variables:
    PROJECT_PATH: services/import-challenges
  before_script:
    - npm ci --ignore-scripts --cache .npm-alpine
    - npm ci --prefix packages/prisma --cache .npm-alpine --prefer-offline
    - npm ci --prefix $PROJECT_PATH --cache .npm-alpine --prefer-offline

test:import-challenges:
  extends:
    - .test
  needs:
   - build:prisma
  variables:
    POSTGRES_DB: a11y-challenges
    POSTGRES_USER: a11y-challenges
    POSTGRES_PASSWORD: secret
    DB_URL: postgresql://a11y-challenges:secret@postgres:5432/a11y-challenges
    PROJECT_PATH: services/import-challenges
  services:
    - postgres
  before_script:
    - npm ci --ignore-scripts --cache .npm-alpine
    - npm ci --prefix packages/prisma --cache .npm-alpine --prefer-offline
    - npm ci --prefix $PROJECT_PATH --cache .npm-alpine --prefer-offline
  only:
    - master
    - develop
    - merge_request

production-dependencies:import-challenges:
  extends:
    - .production-dependencies
  variables:
    PROJECT_PATH: services/import-challenges
  before_script:
    - npm ci --ignore-scripts --cache .npm-cent-os
    - npm ci --production --prefix packages/prisma --cache .npm-cent-os --prefer-offline
  artifacts:
    paths:
      - $PROJECT_PATH/node_modules
      - packages/prisma/client/query-engine-*
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

build:import-challenges:
  extends:
    - .build
  variables:
    PROJECT_PATH: services/import-challenges
  before_script:
    - npm ci --ignore-scripts --cache .npm-alpine
    - npm ci --production --prefix packages/prisma --cache .npm-alpine --prefer-offline
    - npm ci --prefix $PROJECT_PATH --cache .npm-alpine --prefer-offline
  artifacts:
    paths:
      - $PROJECT_PATH/dist
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_request

#-----------------------------------
# Terraform
#-----------------------------------

terraform:cloud:validate:
  extends:
    - .run_on_terraform_change
  tags:
    - docker
  stage: analyze
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  before_script:
    - terraform -chdir=terraform/cloud init
  script:
    - terraform -chdir=terraform/cloud validate

terraform:local:validate:
  extends:
    - .run_on_terraform_change
  tags:
    - docker
  stage: analyze
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  before_script:
    - terraform -chdir=terraform/local init
  script:
    - terraform -chdir=terraform/local validate

#-----------------------------------
# Deployment
#-----------------------------------

deploy-review:
  extends:
    - .deploy
  variables:
   WORKSPACE: review-${CI_MERGE_REQUEST_IID}
  environment:
    name: review/$CI_COMMIT_REF_NAME
    # url: https://$CI_ENVIRONMENT_SLUG.example.com
    on_stop: stop-environment
  only:
    - merge_request

deploy-staging:
  extends:
    - .deploy
  variables:
    WORKSPACE: staging
  environment:
    name: staging
    # url: https://staging.example.com
  only:
    - develop

deploy-production:
  extends:
    - .deploy
  variables:
    WORKSPACE: production
  environment:
    name: production
    # url: https://example.com
  only:
    - master

start-review-app:
  tags:
    - docker
  image: lucapircher/gitlab-ci-heroku
  stage: post-deployment
  script:
    - heroku ps:scale web=1 -a review-${CI_MERGE_REQUEST_IID}-a11yphant-api
  when: manual
  only:
    - merge_request

stop-review-app:
  tags:
    - docker
  image: lucapircher/gitlab-ci-heroku
  stage: post-deployment
  script:
    - heroku ps:scale web=0 -a review-${CI_MERGE_REQUEST_IID}-a11yphant-api
  when: manual
  only:
    - merge_request

stop-environment:
  tags:
    - docker
  stage: deploy
  variables:
    WORKSPACE: review-${CI_MERGE_REQUEST_IID}
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  cache: {} # disable cache
  before_script:
    - terraform -chdir=terraform/cloud init
  script:
    - terraform -chdir=terraform/cloud workspace select $WORKSPACE
    - terraform -chdir=terraform/cloud destroy -var="postgres_cluster_root_password=$TF_PROD_POSTGRES_CLUSTER_ROOT_PASSWORD" -auto-approve
    - terraform -chdir=terraform/cloud workspace select default
    - terraform -chdir=terraform/cloud workspace delete $WORKSPACE
  when: manual
  environment:
    name: review/$CI_COMMIT_REF_NAME
    action: stop
  only:
    - merge_request